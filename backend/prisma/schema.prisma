// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Analyst {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  shiftType   ShiftType  // AM or PM shift assignment
  isActive    Boolean  @default(true)
  
  // NEW: Experience and Employment Classification
  experienceLevel ExperienceLevel @default(JUNIOR)
  employeeType    EmployeeType    @default(FULL_TIME)
  
  customAttributes Json?
  skills      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  preferences AnalystPreference[]
  schedules   Schedule[]
  vacations   Vacation[]
  constraints SchedulingConstraint[]
  leaveRequestImpacts LeaveRequestImpact[]
  
  // Performance indexes for common queries
  @@index([isActive, shiftType]) // For filtering active analysts by shift
  @@index([experienceLevel, employeeType]) // For experience-based selections
  @@index([email]) // Already unique, but explicit for performance
  @@index([createdAt]) // For sorting and date-based queries
  @@map("analysts")
}

model AnalystPreference {
  id          String   @id @default(cuid())
  analystId   String
  shiftType   ShiftType
  dayOfWeek   DayOfWeek
  preference  PreferenceType
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  analyst     Analyst  @relation(fields: [analystId], references: [id], onDelete: Cascade)
  
  // Performance indexes
  @@index([analystId, shiftType, dayOfWeek]) // For preference lookups
  @@index([shiftType, dayOfWeek]) // For shift-based preference queries
  @@unique([analystId, shiftType, dayOfWeek])
  @@map("analyst_preferences")
}

model Vacation {
  id          String   @id @default(cuid())
  analystId   String
  startDate   DateTime
  endDate     DateTime
  reason      String?
  isApproved  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  analyst     Analyst  @relation(fields: [analystId], references: [id], onDelete: Cascade)
  
  // Performance indexes for date range queries
  @@index([analystId, startDate, endDate]) // For analyst vacation lookups
  @@index([startDate, endDate, isApproved]) // For date range queries with approval status
  @@index([isApproved]) // For filtering approved vacations
  @@map("vacations")
}

model SchedulingConstraint {
  id          String   @id @default(cuid())
  analystId   String?
  shiftType   ShiftType?
  startDate   DateTime
  endDate     DateTime
  constraintType ConstraintType
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  analyst     Analyst? @relation(fields: [analystId], references: [id], onDelete: Cascade)
  
  // Performance indexes for constraint queries
  @@index([analystId, startDate, endDate, isActive]) // For analyst constraint lookups
  @@index([startDate, endDate, isActive]) // For date range constraint queries
  @@index([constraintType, isActive]) // For constraint type filtering
  @@map("scheduling_constraints")
}

model Schedule {
  id          String   @id @default(cuid())
  analystId   String
  date        DateTime
  shiftType   ShiftType
  isScreener  Boolean  @default(false)  // Whether this analyst is designated as Screener for this shift
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  analyst     Analyst  @relation(fields: [analystId], references: [id], onDelete: Cascade)
  
  // Critical performance indexes for schedule queries
  @@index([date, shiftType]) // For date-based schedule queries (most common)
  @@index([analystId, date]) // For analyst schedule lookups
  @@index([date, isScreener]) // For screener assignment queries
  @@index([analystId, date, shiftType]) // For specific analyst/date/shift queries
  @@index([date]) // For pure date-based queries
  @@unique([analystId, date])
  @@map("schedules")
}

model AlgorithmConfig {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  config      Json
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Performance indexes
  @@index([isActive]) // For filtering active algorithms
  @@index([name]) // For algorithm name lookups
  @@map("algorithm_configs")
}

model CalendarEvent {
  id          String        @id @default(cuid())
  title       String
  startDate   DateTime
  endDate     DateTime
  eventType   EventType     @default(HOLIDAY)
  calendarType CalendarType @default(EVENT)
  description String?
  
  // Auto-generated constraints with override capability
  defaultConstraints  Json    // System-generated based on eventType
  overrideConstraints Json?   // User overrides for specific scenarios
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Performance indexes for calendar queries
  @@index([startDate, endDate, calendarType]) // For date range queries by calendar type
  @@index([eventType]) // For filtering by event type
  @@index([calendarType]) // For calendar toggle functionality
  @@map("calendar_events")
}

enum ShiftType {
  MORNING
  EVENING
  WEEKEND
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PreferenceType {
  PREFERRED
  AVAILABLE
  UNAVAILABLE
}

enum ConstraintType {
  BLACKOUT_DATE      // No scheduling allowed
  MAX_SCREENER_DAYS  // Maximum screener assignments per analyst
  MIN_SCREENER_DAYS  // Minimum screener assignments per analyst
  PREFERRED_SCREENER // Preferred screener for specific dates
  UNAVAILABLE_SCREENER // Unavailable for screener on specific dates
}

enum ExperienceLevel {
  JUNIOR
  MID_LEVEL
  SENIOR
  EXPERT
}

enum EmployeeType {
  FULL_TIME
  ROTATION
  CONSULTANT
}

enum EventType {
  MAJOR_RELEASE     // Needs 1 full-time OR 1 senior consultant
  MINOR_RELEASE     // Needs 1 senior consultant minimum
  HOLIDAY           // No additional constraints
  PARTNER_DOWNTIME  // Partner system maintenance
}

enum CalendarType {
  SHIFT    // Contains shift assignments and screening
  EVENT    // Major events and corporate holidays
  PARTNER  // Minor releases and partner downtime
}

// Algorithm Auditing and Performance Tracking
model AlgorithmAudit {
  id                  String   @id @default(cuid())
  
  // Execution context
  algorithmName       String
  version             String
  startDate           DateTime
  endDate             DateTime
  analystCount        Int
  executionTime       Float    // milliseconds
  
  // Configuration used
  configuration       Json     // Full algorithm configuration
  
  // Outcomes and metrics
  schedulesGenerated  Int
  conflictsFound      Int
  overwrites          Int
  fairnessScore       Float
  constraintScore     Float
  efficiencyScore     Float
  overallScore        Float
  
  // Success indicators
  success             Boolean  @default(true)
  errorMessage        String?
  
  // Relationships
  decisions           DecisionAudit[]
  metrics             PerformanceMetrics[]
  recommendations     AuditRecommendation[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Performance indexes
  @@index([algorithmName, createdAt])
  @@index([success, overallScore])
  @@index([startDate, endDate])
  @@map("algorithm_audits")
}

model DecisionAudit {
  id                  String   @id @default(cuid())
  
  // Audit context
  algorithmAuditId    String
  algorithmAudit      AlgorithmAudit @relation(fields: [algorithmAuditId], references: [id], onDelete: Cascade)
  
  // Decision details
  decisionType        DecisionType
  strategy            String           // Which strategy was used
  analystId           String?          // Analyst involved in decision
  date                DateTime?        // Date being scheduled
  shiftType           String?          // MORNING/EVENING
  
  // Decision context
  alternatives        Int              // Number of alternatives considered
  selectionScore      Float            // Score of selected option
  selectionReason     String           // Human-readable reason
  constraints         Json?            // Constraints that influenced decision
  
  // Outcome tracking (filled in later)
  actualOutcome       String?          // What actually happened
  outcomeScore        Float?           // How well the decision worked
  feedback            String?          // Any manual feedback
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Performance indexes
  @@index([algorithmAuditId])
  @@index([decisionType, strategy])
  @@index([analystId, date])
  @@map("decision_audits")
}

model PerformanceMetrics {
  id                  String   @id @default(cuid())
  
  // Context
  algorithmAuditId    String
  algorithmAudit      AlgorithmAudit @relation(fields: [algorithmAuditId], references: [id], onDelete: Cascade)
  
  // Metric details
  metricType          String           // Type of metric (e.g., "fairness", "efficiency")
  category            String           // Category (e.g., "screener_selection", "optimization")
  value               Float            // Metric value
  baseline            Float?           // Baseline comparison value
  improvement         Float?           // Improvement over baseline
  
  // Context data
  metadata            Json?            // Additional metric context
  
  createdAt           DateTime @default(now())
  
  // Performance indexes
  @@index([algorithmAuditId])
  @@index([metricType, category])
  @@index([createdAt])
  @@map("performance_metrics")
}

model AuditRecommendation {
  id                  String   @id @default(cuid())
  
  // Context
  algorithmAuditId    String?
  algorithmAudit      AlgorithmAudit? @relation(fields: [algorithmAuditId], references: [id], onDelete: Cascade)
  
  // Recommendation details
  type                RecommendationType
  priority            RecommendationPriority
  title               String
  description         String
  
  // Actionable data
  currentValue        Json?            // Current configuration/state
  recommendedValue    Json?            // Recommended configuration/state
  expectedImprovement Float?           // Expected improvement metric
  confidence          Float            // Confidence in recommendation (0-1)
  
  // Implementation tracking
  status              RecommendationStatus @default(PENDING)
  implementedAt       DateTime?
  implementedBy       String?
  result              String?          // Outcome after implementation
  
  // Analysis context
  analysisData        Json?            // Supporting analysis data
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Performance indexes
  @@index([type, priority, status])
  @@index([confidence])
  @@index([createdAt])
  @@map("audit_recommendations")
}

// Supporting enums for audit system
enum DecisionType {
  SCREENER_SELECTION
  WEEKEND_ROTATION
  OPTIMIZATION_STRATEGY
  CONSTRAINT_RESOLUTION
  TIE_BREAKING
  FAIRNESS_ADJUSTMENT
}

enum RecommendationType {
  CONFIGURATION_CHANGE
  STRATEGY_OPTIMIZATION
  PERFORMANCE_IMPROVEMENT
  CONSTRAINT_ADJUSTMENT
  ALGORITHM_UPGRADE
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RecommendationStatus {
  PENDING
  REVIEWED
  APPROVED
  IMPLEMENTED
  REJECTED
  EXPIRED
}

// Phase 3: Predictive Fairness & Advanced Analytics Tables

model FairnessMetrics {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date
  overallScore        Decimal  @db.Decimal(3, 2)
  workloadFairness    Decimal  @db.Decimal(3, 2)
  weekendFairness     Decimal  @db.Decimal(3, 2)
  assignmentFairness  Decimal  @db.Decimal(3, 2)
  confidenceScore     Decimal  @db.Decimal(3, 2)
  metadata            Json?    // Additional fairness context data
  createdAt           DateTime @default(now())
  
  // Performance indexes
  @@index([date])
  @@index([overallScore])
  @@index([createdAt])
  @@map("fairness_metrics")
}

model LeaveRequestImpact {
  id                    String   @id @default(cuid())
  requestId             String   // Reference to leave request (could be external)
  analystId             String
  startDate             DateTime @db.Date
  endDate               DateTime @db.Date
  fairnessImpactBefore  Decimal  @db.Decimal(3, 2)
  fairnessImpactAfter   Decimal  @db.Decimal(3, 2)
  riskLevel             String   // LOW, MEDIUM, HIGH
  recommendations       String[] // Array of recommendation strings
  alternativeDates      DateTime[] @db.Date // Suggested alternative dates
  metadata              Json?    // Additional impact analysis data
  createdAt             DateTime @default(now())
  
  // Relationships
  analyst               Analyst  @relation(fields: [analystId], references: [id], onDelete: Cascade)
  
  // Performance indexes
  @@index([analystId])
  @@index([startDate, endDate])
  @@index([riskLevel])
  @@index([createdAt])
  @@map("leave_request_impacts")
}

model KPIMetrics {
  id                      String   @id @default(cuid())
  date                    DateTime @db.Date
  scheduleSuccessRate     Decimal  @db.Decimal(3, 2)
  averageFairnessScore    Decimal  @db.Decimal(3, 2)
  constraintViolationRate Decimal  @db.Decimal(3, 2)
  userSatisfactionScore   Decimal  @db.Decimal(3, 2)
  conflictResolutionTime  Decimal  @db.Decimal(5, 2) // Hours
  metadata                Json?    // Additional KPI context data
  createdAt               DateTime @default(now())
  
  // Performance indexes
  @@index([date])
  @@index([scheduleSuccessRate])
  @@index([averageFairnessScore])
  @@index([createdAt])
  @@map("kpi_metrics")
}
